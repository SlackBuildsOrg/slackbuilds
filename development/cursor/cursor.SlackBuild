#!/bin/bash

cd "$(dirname "$0")" ; CWD="$(pwd)"

PRGNAM=cursor
VERSION=${VERSION:-1.7.28}
BUILD=${BUILD:-1}
TAG=${TAG:-_SBo}
PKGTYPE=${PKGTYPE:-tgz}

SRCDEB=${SRCDEB:-Cursor-$VERSION-amd64.deb}

if [ -z "${ARCH:-}" ]; then
  case "$(uname -m)" in
    x86_64) ARCH=x86_64 ;;
    *) ARCH=$(uname -m) ;;
  esac
fi
[ "$ARCH" != "x86_64" ] && { echo "Only x86_64."; exit 1; }

if [ -n "${PRINT_PACKAGE_NAME:-}" ]; then
  echo "$PRGNAM-$VERSION-$ARCH-$BUILD$TAG.$PKGTYPE"
  exit 0
fi

TMP=${TMP:-/tmp/SBo}
PKG="$TMP/package-$PRGNAM"
OUTPUT=${OUTPUT:-/tmp}

set -e

die() { echo "ERRO: $*" >&2; exit 1; }

[ -f "$CWD/$SRCDEB" ] || die "ERRO .deb: $CWD/$SRCDEB"
[ -f "$CWD/$PRGNAM.desktop" ] || die "ERRO $PRGNAM.desktop"

rm -rf "$PKG"
mkdir -p "$TMP" "$PKG" "$OUTPUT"
cd "$TMP"
rm -rf "$PRGNAM-$VERSION"
mkdir -p "$PRGNAM-$VERSION"
cd "$PRGNAM-$VERSION"

ar x "$CWD/$SRCDEB"
tar --auto-compress -xf data.tar.* -C .

chown -R root:root .
find -L . \
 \( -perm 777 -o -perm 775 -o -perm 750 -o -perm 711 -o -perm 555 \
  -o -perm 511 \) -exec chmod 755 {} \; -o \
 \( -perm 666 -o -perm 664 -o -perm 640 -o -perm 600 -o -perm 444 \
  -o -perm 440 -o -perm 400 \) -exec chmod 644 {} \;

mkdir -p "$PKG/usr/bin"

BIN_OK=0

if [ -x "./usr/share/$PRGNAM/bin/$PRGNAM" ]; then
  mkdir -p "$PKG/usr/share/$PRGNAM/bin"
  cp -a "./usr/share/$PRGNAM/bin/$PRGNAM" "$PKG/usr/share/$PRGNAM/bin/"

  ( cd "$PKG/usr/bin" && ln -sf ../share/$PRGNAM/bin/$PRGNAM $PRGNAM )
  BIN_OK=1
fi

if [ $BIN_OK -eq 0 ] && [ -x "./opt/Cursor/$PRGNAM" ]; then
  mkdir -p "$PKG/opt/$PRGNAM"
  cp -a "./opt/Cursor/"* "$PKG/opt/$PRGNAM/"
  ( cd "$PKG/usr/bin" && ln -sf ../../opt/$PRGNAM/$PRGNAM $PRGNAM )
  BIN_OK=1
fi

[ $BIN_OK -eq 1 ] || die "Não encontrei executável ($PRGNAM) em usr/share/$PRGNAM/bin nem em opt/Cursor."

[ -L "$PKG/usr/bin/$PRGNAM" ] || die "Falha ao criar symlink em /usr/bin/$PRGNAM."

mkdir -p "$PKG/usr/share/applications"
cp $CWD/$PRGNAM.desktop $PKG/usr/share/applications

mkdir -p $PKG/install
cat $CWD/slack-desc > $PKG/install/slack-desc
cat $CWD/doinst.sh > $PKG/install/doinst.sh

cd "$PKG"
/sbin/makepkg -l y -c n "$OUTPUT/$PRGNAM-$VERSION-$ARCH-$BUILD$TAG.$PKGTYPE"
